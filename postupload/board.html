<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title> 게시판 관리 </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet prefetch' href='http://www.tinymce.com/css/codepen.min.css'>
  <!-- <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css"> -->
  <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="css/bootstrap-editable/bootstrap-editable.css" >
  <!-- x-editable (bootstrap version) -->
  <!-- <link href="http://cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet"/> -->

  <style>
    .popover {
      width: 500px
    }
  </style>

</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">Selphone</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="./dashboard.html">Dash board</a></li>
          <li><a href="./posts.html">게시글관리</a></li>
          <li class="active"><a href="./board.html">게시판관리</a></li>
          <li><a href="./orders.html">결제 정보 관리</a></li>
          <li><a href="./reports.html">신고 내역</a></li>
          <li><a href="./content_upload.html">셀폰 콘텐츠</a></li>
          <li><a href="./users.html">회원관리</a></li>
        </ul>
         <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a id="userIdNav" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a id="logoutBtn" >로그아웃</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <br><br><br>

  <div class="container">
    <div class="row">
      <div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div>
              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#faq" aria-controls="faq" role="tab" data-toggle="tab">자주묻는질문</a></li>
                <li role="presentation"><a href="#selphone_notice" aria-controls="selphone_notice" role="tab" data-toggle="tab">셀폰 공지사항</a></li>
                <li role="presentation"><a href="#manager_notice" aria-controls="manager_notice" role="tab" data-toggle="tab">매니저 공지사항</a></li>
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="faq">
                  <table id="faqTable"class="table">
                    <thead>
                      <tr>
                        <th>/</th><th>제목</th><th>내용</th><th>순서</th><th>삭제</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button id="addFaqBtn" type="button" class="btn btn-primary pull-right">추가하기!</button>
                </div>

                <div role="tabpanel" class="tab-pane" id="selphone_notice">
                  <table id="selNoticeTable" class="table">
                    <thead>
                      <tr>
                        <th>/</th><th>제목</th><th>내용</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button id="addSelphoneBtn" value="sell" type="button" class="btn btn-primary pull-right">추가하기</button>
                </div>
                <div role="tabpanel" class="tab-pane" id="manager_notice">
                  <table id="selManagerTable" class="table">
                    <thead>
                      <tr>
                        <th>/</th><th>제목</th><th>내용</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button id="addManagerBtn" type="button" class="btn btn-primary pull-right" >추가하기</button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
      <div>

      </div>
    </div>
    <!-- <textarea id="myTextarea"><p style="font-size: 15px;"></textarea> -->
  </div>


    <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">추가하기</h4>
        </div>
        <div class="modal-body">
          <form id="modalForm" role="form">
            <div class="form-group">
              <label for="popoverTitle">제목</label>
              <textarea class="form-control" name="title" id="popoverTitle" placeholder="제목을 입력하세요" required></textarea>
            </div>
            <div class="form-group">
              <label for="myTextarea">내용</label>
              <textarea id="myTextarea" name="contents" placeholder="내용을 입력하세요"></textarea>
            </div>
            <div>
              <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-primary">저장</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</body>
<!-- <script src="./script/jquery-2.1.4.min.js" ></script> -->
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="./script/custom/common.js" ></script>
<!-- <script src="./script/bootstrap/bootstrap.min.js"></script> -->
<!-- <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script> -->
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="./script/bootstrap-editable/bootstrap-editable.min.js"></script>
<script src='http://cdn.tinymce.com/4/tinymce.min.js'></script>
<!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/js/bootstrap-editable.min.js"></script> -->
<script type="text/javascript" >
  var Faqs = function(faq){
    var faq;
    return{
      set : function(_faq){
        faq = _faq
      },
      all : function(){
        return faq
      },
      get : function(_id){
        for(i in faq){
          if(faq[i].id == _id)
            return faq[i];
        }
        return null;
      }
    }
  }

  var SelNotice = function(notice){
    var notice;
    return{
      set : function(_notice){
        notice = _notice
      },
      all : function(){
        return notice
      },
      get : function(_id){
        for(i in notice){
          if(notice[i].id == _id)
            return notice[i];
        }
        return null;
      }
    }
  }

  var ManagerNotice = function(notice){
    var notice;
    return{
      set : function(_notice){
        notice = _notice
      },
      all : function(){
        return notice
      },
      get : function(_id){
        for(i in notice){
          if(notice[i].id == _id)
            return notice[i];
        }
        return null;
      }
    }
  }
  $(document).on('focusin', function(e) { // link를 수정못하게 하는 에러 해결책
    if ($(event.target).closest(".mce-window").length) {
      e.stopImmediatePropagation();
    }
  });
  $(document).ready(function(){
    loginCheck().done(function(data){
      if(!data.is_login){
        alert("로그인이 필요합니다.")
        location.href = "./login.html"
      }else{
        focusNowTab();
        tinymceInit();
        getFaqs();
        getSelphoneNotices();
        getMangerNotices();

      }
    });
  });

  $('#addFaqBtn').click(function(e){
    initModal()
    $('#myModalLabel').text("자주묻는 질문 추가")
    $('#modalForm').submit(function(e){
      e.preventDefault();
      ajax('POST', '/faqs', $(this).serialize(), {})
      .done(function(data){
        location.reload();
      })
      .fail(function(err){
        console.log("err", err);
        alert("추가에 실패했습니다.")
      });
    })
  });
  $('#addSelphoneBtn').click(function(e){
    initModal()
    $('#myModalLabel').text("셀폰 공지 추가")
    $('#modalForm').submit(function(e){
      e.preventDefault();
      ajax('POST', '/selphone-notices', $(this).serialize(), {})
      .done(function(data){
        location.reload();
      })
      .fail(function(err){
        console.log("err", err);
        alert("추가에 실패했습니다.")
      });
    })
  });
  $('#addManagerBtn').click(function(e){
    initModal()
    // $('#myModal').modal('show');
    $('#myModalLabel').text("업체 공지 추가")
    $('#modalForm').submit(function(e){
      e.preventDefault();
      ajax('POST', '/manager-notices', $(this).serialize(), {})
      .done(function(data){
        location.reload();
      })
      .fail(function(err){
        console.log("err", err);
        alert("추가에 실패했습니다.")
      });
    })
  });

  $('table tbody').on('click', 'tr', function (e){
    // console.log("$(this).attr('class')", $(this).attr('class'));
    var url;
    var _class;
    switch($(this).attr('class')){
      case 'faqTable' : url = '/faqs/' ; _class = faqs; break;
      case 'selNoticeTable' : url = '/selphone-notices/' ;  _class = s_notices; break;
      case 'selManagerTable' : url = '/manager-notices/' ;  _class = m_notices; break;
    }
    var nodes = $(this).contents()
    // console.log("형제 ", nodes);
    var id = nodes[0].innerHTML
    var title = nodes[1].innerHTML;
    // var contents = nodes[2].innerHTML;
    var deleteBtn
    if(nodes.length > 4){
      deleteBtn = nodes[4]
    }else{
      deleteBtn = nodes[3]
    }
    // console.log("$(this)", $(this));
    // console.log("id", id);
    // console.log("faqs", _class.get(id).contents);
    tinymce.activeEditor.setContent(_class.get(id).contents);
    // if( !$(this).hasClass('deleteBtn') ){
      $('#myModal').modal('show');
      $('#popoverTitle').val(title)
      $('#myModalLabel').text("수정하기")
      $('#modalForm').submit(function(e){
        e.preventDefault();
        ajax('PUT', url+id, $(this).serialize(), {})
        .done(function(data){
          location.reload()
        })
        .fail(function(err){
          console.log("err", err);
          alert(err)
        });
      });
    // }
  });

  // rich text editor
  var tinymceInit = function(){
    tinymce.init({
      selector: '#myTextarea',
      height: 300,
      theme: 'modern',
      plugins: [
        'advlist autolink lists link image charmap print preview hr anchor pagebreak',
        'searchreplace wordcount visualblocks visualchars code fullscreen',
        'insertdatetime media nonbreaking save table contextmenu directionality',
        'emoticons template paste textcolor colorpicker textpattern imagetools',
      ],
      toolbar1: 'insertfile undo redo | styleselect | bold italic | bullist numlist  | link image',
      toolbar2: ' preview media | forecolor backcolor',
      image_advtab: true,
      content_css: [
        'http://fast.fonts.net/cssapi/e6dc9b99-64fe-4292-ad98-6974f93cd2a2.css',
        'http://www.tinymce.com/css/codepen.min.css'
      ]
   });
  }

  var getFaqs = function(){
    ajax('GET', '/faqs', null, {})
    .done(function(data){
      faqs = Faqs(data.results);
      makeTable('faqTable', faqs.all());
    })
    .fail(function(err){
      alert(err)
    });
  };

  var getSelphoneNotices = function(){
    ajax('GET', '/selphone-notices', null, {})
    .done(function(data){
      s_notices = SelNotice(data.results);
      makeTable('selNoticeTable', s_notices.all());
    })
    .fail(function(err){
      alert(err)
    });
  };

  var getMangerNotices = function(){
    ajax('GET', '/manager-notices', null, {})
    .done(function(data){
      m_notices = ManagerNotice(data.results);
      makeTable('selManagerTable', m_notices.all());
    })
    .fail(function(err){
      alert(err)
    });
  };

  var focusNowTab = function(){
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      localStorage.setItem('lastTab', $(this).attr('href'));
    });
    var lastTab = localStorage.getItem('lastTab');
    if (lastTab) {
      $('[href="' + lastTab + '"]').tab('show');
    }
  };

  var initModal = function(){
    $('#myModal').modal('show');
    $('#popoverTitle').val("")
    tinymce.activeEditor.setContent("");
  };

  var makeTable = function(table_id, results){
    for( i in results ){
      var id = results[i].id
      var html = '';
          html += '<tr id="'+id+'" class="'+table_id+'">';
          html += '<td>'+id+'</td>';
          html += '<td>'+results[i].title+'</td>'
          html += '<td class="contents">'+results[i].contents+'</td>'
          if(table_id == 'faqTable') html += '<td>'+results[i].order+'</td>'
          html += '<td class="deleteBtn"><button class="deleteBtn btn btn-danger" value="'+id+'"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button></td>'
          html += '</tr>'
      $('#'+table_id+' tbody').append(html);
    }

    $('tbody button.deleteBtn').unbind().click(function(){
      var url;
      switch($(this).parents('tr').attr('class')){
        case 'faqTable' : url='/faqs/' ; break;
        case 'selNoticeTable' : url='/selphone-notices/' ; break;
        case 'selManagerTable' : url='/manager-notices/' ; break;
      }
      ajax('DELETE', url+$(this).val(), null, {})
      .done(function(data){
        location.reload();
      })
      .fail(function(err){
        console.log("err", err);
        alert('삭제 실패했습니다.')
      });
    })

  }

</script>

</html>