<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title> 게시판 관리 </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet prefetch' href='http://www.tinymce.com/css/codepen.min.css'>
  <!-- <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css"> -->
  <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="css/bootstrap-editable/bootstrap-editable.css" >
  <!-- x-editable (bootstrap version) -->
  <!-- <link href="http://cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet"/> -->

  <style>
    .popover {
      width: 500px
    }
  </style>

</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">Selphone</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="./dashboard.html">Dash board</a></li>
          <li><a href="./posts.html">게시글관리</a></li>
          <li class="active"><a href="./board.html">게시판관리</a></li>
          <li><a href="./orders.html">결제 정보 관리</a></li>
          <li><a href="./reports.html">신고 내역</a></li>
          <li><a href="./content_upload.html">셀폰 콘텐츠</a></li>
          <li><a href="./users.html">회원관리</a></li>
        </ul>
         <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a id="userIdNav" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a id="logoutBtn" >로그아웃</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <br><br><br>

  <div class="container">
    <div class="row">
      <div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div>
              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#faq" aria-controls="faq" role="tab" data-toggle="tab">자주묻는질문</a></li>
                <li role="presentation"><a href="#selphone_notice" aria-controls="selphone_notice" role="tab" data-toggle="tab">셀폰 공지사항</a></li>
                <li role="presentation"><a href="#manager_notice" aria-controls="manager_notice" role="tab" data-toggle="tab">매니저 공지사항</a></li>
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="faq">
                  <table id="faqTable"class="table">
                    <thead>
                      <tr>
                        <th>/</th><th>제목</th><th>내용</th><th>순서</th><th>삭제</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button id="add_faq" type="button" class="btn btn-primary pull-right"  data-toggle="popover" data-placement="top">추가하기</button>

                  <!-- <button type="button" class="btn btn-primary pull-right" data-toggle="modal" data-target="#myModal">Launch demo modal</button> -->
                </div>

                <div role="tabpanel" class="tab-pane" id="selphone_notice">
                  <table id="selNoticeTable" class="table">
                    <thead>
                      <tr>
                        <th>/</th><th>제목</th><th>내용</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button id="add_selphone" type="button" class="btn btn-primary pull-right"  data-toggle="popover" data-placement="top">추가하기</button>
                </div>
                <div role="tabpanel" class="tab-pane" id="manager_notice">
                  <table id="selManagerTable" class="table">
                    <thead>
                      <tr>
                        <th>/</th><th>제목</th><th>내용</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button id="add_manager" type="button" class="btn btn-primary pull-right"  data-toggle="popover" data-placement="top">추가하기</button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
      <div>

      </div>
    </div>
    <textarea id="myTextarea"><p style="font-size: 15px;"></textarea>
  </div>

  <div id="popover-content-faq" class="hide">
    <form id="addFaqForm" role="form">
      <div class="form-group">
        <label for="popoverTitle">제목</label>
        <textarea class="form-control" name="title" id="popoverTitle" placeholder="제목을 입력하세요" required></textarea>
      </div>
      <div class="form-group">
        <label for="popoverContents">내용</label>
        <textarea class="form-control" name="contents" rows="5" id="popoverContents" placeholder="내용을 입력하세요" required></textarea>
      </div>
      <div class="form-group">
        <label for="popoverOrder">순서</label>
        <input type="number" class="form-control" name="order" id="popoverOrder" placeholder="순서를 입력하세요" required>
      </div>
      <button type="submit" class="btn btn-primary pull-center">저장</button>
    </form>
  </div>
  <div id="popover-content-selphone" class="hide">
    <form id="addSelphoneForm" role="form">
      <div class="form-group">
        <label for="popoverTitle">제목</label>
        <textarea class="form-control" name="title" id="popoverTitle" placeholder="제목을 입력하세요" required></textarea>
      </div>
      <div class="form-group">
        <label for="popoverContents">내용</label>
        <textarea class="form-control" name="contents" rows="5" id="popoverContents" placeholder="내용을 입력하세요" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary pull-center">저장</button>
    </form>
  </div>
  <div id="popover-content-manager" class="hide">
    <form id="addManagerForm" role="form">
      <div class="form-group">
        <label for="popoverTitle">제목</label>
        <textarea class="form-control" name="title" id="popoverTitle" placeholder="제목을 입력하세요" required></textarea>
      </div>
      <div class="form-group">
        <label for="popoverContents">내용</label>
        <textarea class="form-control" name="contents" rows="5" id="popoverContents" placeholder="내용을 입력하세요" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary pull-center">저장</button>
    </form>
  </div>

</body>
<!-- <script src="./script/jquery-2.1.4.min.js" ></script> -->
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="./script/custom/common.js" ></script>
<!-- <script src="./script/bootstrap/bootstrap.min.js"></script> -->
<!-- <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script> -->
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="./script/bootstrap-editable/bootstrap-editable.min.js"></script>
<script src='http://cdn.tinymce.com/4/tinymce.min.js'></script>
<!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/js/bootstrap-editable.min.js"></script> -->
<script type="text/javascript" >

  $(document)
  .ready(function(){
    loginCheck().done(function(data){
      if(!data.is_login){
        alert("로그인이 필요합니다.")
        location.href = "./login.html"
      }else{
        focusNowTab();
        tinymceInit();
        getFaqs();
        getSelphoneNotices();
        getMangerNotices();
        addSaveBtn();
        $('#add_faq').click(function(){
          console.log("tinymce", tinymce.activeEditor.getContent());
        })
      }
    });
  })
  .on('submit', '#addFaqForm', function(e){
    e.preventDefault();
    ajax('POST', '/faqs', $(this).serialize(), {})
    .done(function(data){
      location.reload();
    })
    .fail(function(err){
      console.log("err", err);
      alert("추가에 실패했습니다.")
    });
  })
  .on('submit', '#addSelphoneForm', function(e){
    e.preventDefault();
    ajax('POST', '/selphone-notices', $(this).serialize(), {})
    .done(function(data){
      location.reload();
    })
    .fail(function(err){
      console.log("err", err);
      alert("추가에 실패했습니다.")
    });
  })
  .on('submit', '#addManagerForm', function(e){
    e.preventDefault();
    ajax('POST', '/manager-notices', $(this).serialize(), {})
    .done(function(data){
      location.reload();
    })
    .fail(function(err){
      console.log("err", err);
      alert("추가에 실패했습니다.")
    });
  });

  var addSaveBtn = function(){
    $('#add_faq').popover({
      // container : 'body',
      title : '자주묻는 질문 추가',
      html : true,
      content : function(){
        return  $("#popover-content-faq").html();
      }
    });
    $('#add_selphone').popover({
      // container : 'body',
      title : '셀폰공지 추가',
      html : true,
      content : function(){
        return  $("#popover-content-selphone").html();
      }
    });
    $('#add_manager').popover({
      // container : 'body',
      title : '업체공지 추가',
      html : true,
      content : function(){
        return  $("#popover-content-manager").html();
      }
    });
  };


  // rich text editor
  var tinymceInit = function(){
    tinymce.init({
      selector: '#myTextarea',
      height: 150,
      theme: 'modern',
      plugins: [
        'advlist autolink lists link image charmap print preview hr anchor pagebreak',
        'searchreplace wordcount visualblocks visualchars code fullscreen',
        'insertdatetime media nonbreaking save table contextmenu directionality',
        'emoticons template paste textcolor colorpicker textpattern imagetools',
      ],
      toolbar1: 'insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
      toolbar2: 'print preview media | forecolor backcolor emoticons',
      image_advtab: true,
      content_css: [
        'http://fast.fonts.net/cssapi/e6dc9b99-64fe-4292-ad98-6974f93cd2a2.css',
        'http://www.tinymce.com/css/codepen.min.css'
      ]
   });
  }

  var getFaqs = function(){
    ajax('GET', '/faqs', null, {})
    .done(function(data){
      makeTable('faqTable', data.results);
    })
    .fail(function(err){
      alert(err)
    });
  };

  var getSelphoneNotices = function(){
    ajax('GET', '/selphone-notices', null, {})
    .done(function(data){
      makeTable('selNoticeTable', data.results);
    })
    .fail(function(err){
      alert(err)
    });
  }

  var getMangerNotices = function(){
    ajax('GET', '/manager-notices', null, {})
    .done(function(data){
      makeTable('selManagerTable', data.results);
    })
    .fail(function(err){
      alert(err)
    });
  }

  var focusNowTab = function(){
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      // save the latest tab; use cookies if you like 'em better:
      localStorage.setItem('lastTab', $(this).attr('href'));
    });
    // go to the latest tab, if it exists:
    var lastTab = localStorage.getItem('lastTab');
    if (lastTab) {
      $('[href="' + lastTab + '"]').tab('show');
    }
  }

  var makeTable = function(table_id, results){
    for( i in results ){
      var id = results[i].id
      var html = '';
          html += '<tr class="'+table_id+'">';
          html += '<td>'+id+'</td>';
          html += '<td><div data-pk="'+id+'" id="title" data-type="textarea">'+results[i].title+'</div></td>'
          html += '<td><div data-pk="'+id+'" id="contents" data-type="textarea" >'+results[i].contents+'</div></td>'
          if(table_id == 'faqTable') html += '<td><div data-pk="'+id+'" id="order" data-type="text" >'+results[i].order+'</div></td>'
          html += '<td><button class="deleteBtn btn btn-danger" value="'+id+'"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button></td>'
          html += '</tr>'
      $('#'+table_id+' tbody').append(html);
    }


    $.fn.editable.defaults.mode = 'inline';
    $('tbody div').editable({
      url: URL+'/employees/notice',
      ajaxOptions: {
          type: 'put',
          dataType: 'json',
      },
      validate: function(value) {
        if($.trim(value) == '') {
            return '값을 입력해주세요';
        }
      },
      params: function(params) {
        var datas = {
          id : params.pk,
        }
        datas[params['name']] = params.value
        switch(table_id){
          case 'faqTable' : datas.board_type = 'faq'; break;
          case 'selNoticeTable' : datas.board_type = 'selphone'; break;
          case 'selManagerTable' : datas.board_type = 'manager'; break;
        }
        return datas
      },
      error: function(res, value){
        if(res.status === 500) {
          console.log(res.responseText);
          return '변경에 실패했습니다.';
        } else {
          return res.responseText;
        }
      },
      send: 'always',
      title : "변경정보를 입력해주세요.",
      rows : 10
    });

    $('tbody button.deleteBtn').unbind().click(function(){
      var delete_datas = 'board_type='
      switch($(this).parents('tr').attr('class')){
        case 'faqTable' : delete_datas+='faq' ; break;
        case 'selNoticeTable' : delete_datas+='selphone' ; break;
        case 'selManagerTable' : delete_datas+='manager' ; break;
      }

      console.log(delete_datas);
      ajax('DELETE', '/employees/notice/'+$(this).val(), delete_datas, {})
      .done(function(data){
        location.reload();
      })
      .fail(function(err){
        console.log("err", err);
        alert('삭제 실패했습니다.')
      });
    })

  }

</script>

</html>