<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>현황판</title>

<link rel="stylesheet" href="./css/datatable/jquery.dataTables.min.css" />
<link rel="stylesheet" href="./css/bootstrap/bootstrap.min.css">
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
<link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />



</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">Selphone</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="./dashboard.html">Dash board</a></li>
          <li><a href="./posts.html">게시글관리</a></li>
          <li><a href="./board.html">게시판 관리</a></li>
          <li><a href="./orders.html">결제 정보 관리</a></li>
          <li ><a href="./reports.html">신고 내역</a></li>
          <li><a href="./content_upload.html">셀폰 콘텐츠</a></li>
          <li><a href="./users.html">회원관리</a></li>
          <li><a href="./stores.html">업체관리</a></li>
        </ul>
         <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a id="userIdNav" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a id="logoutBtn" >로그아웃</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>





  <br><br><br>



  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <div class="panel panel-default">
            <div class="panel-heading">
              <h4>통계 그래프</h4>
            </div>
            <div class="panel-body">
              <div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                  <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">사용자</a></li>
                  <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Todo</a></li>
                  <!-- <li role="presentation"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">Messages</a></li> -->
                  <!-- <li role="presentation"><a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Settings</a></li> -->
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                  <div role="tabpanel" class="tab-pane active" id="home">
                      <div id="line-example"></div>
                  </div>
                  <div role="tabpanel" class="tab-pane" id="profile">To be continue..</div>
                  <!-- <div role="tabpanel" class="tab-pane" id="messages">...</div> -->
                  <!-- <div role="tabpanel" class="tab-pane" id="settings">...</div> -->
                </div>

              </div>
            </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <div class="panel panel-success">
            <div class="panel-heading">
              <h4>기간선택</h4>
            </div>
            <div class="panel-body">
              <!-- <input class="form-control" type="text" name="daterange" value="01/01/2015 - 01/31/2015" /> -->
              <input class="form-control" type="text" id="daterange" style="text-align: center;"/>
            </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
            <div class="panel-heading">
              <h4>사용자</h4>
            </div>
            <div class="panel-body">
              <table id="userTable" class="table table-bordered table-hover">
                <tbody>
                  <tr>
                    <td>다운로드</td>
                    <td><b id="download_count"></b> 명</td>
                  </tr>
                  <tr>
                    <td>일일사용자</td>
                    <td><b id="user_count"></b> 명</td>
                  </tr>
                  <tr>
                    <td>체류시간</td>
                    <td><b id="duration_time"></b></td>
                  </tr>
                </tbody>
              </table>
            </div>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="panel panel-default">
            <div class="panel-heading">
              <h4>매입업체</h4>
            </div>
            <div class="panel-body">
              <table id="storeTable" class="table table-bordered table-hover">
                <tbody>
                  <tr>
                    <td>조회율(다운로드 대비)</td>
                    <td><b id="sell_store_click_rate1"></b> %</td>
                  </tr>
                  <tr>
                    <td>조회율(사용자 대비)</td>
                    <td><b id="sell_store_click_rate2"></b> %</td>
                  </tr>
                  <tr>
                    <td>연락 전환율</td>
                    <td><b id="sell_store_contact_rate"></b> %</td>
                  </tr>
                </tbody>
              </table>
            </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
            <div class="panel-heading">
              <h4>개인거래</h4>
            </div>
            <div class="panel-body">
              <table id="postTable" class="table table-bordered table-hover">
                <tbody>
                  <tr>
                    <td>판매글 등록율(다운로드 대비)</td>
                    <td><b id="market_post_rate1"></b> %</td>
                  </tr>
                  <tr>
                    <td>판매글 등록율(사용자 대비)</td>
                    <td><b id="market_post_rate2"></b> %</td>
                  </tr>
                  <tr>
                    <td>판매 완료율</td>
                    <td><b id="market_sell_rate"></b> %</td>
                  </tr>
                </tbody>
              </table>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
              <h4>수리업체 - 조회율</h4>
            </div>
            <div class="panel-body">
              <table id="postTable" class="table table-bordered table-hover">
                <tbody>
                  <tr>
                    <td>조회율(다운로드 대비)</td>
                    <td><b id="repair_store_click_rate1"></b> %</td>
                  </tr>
                  <tr>
                    <td>조회율(사용자 대비)</td>
                    <td><b id="repair_store_click_rate2"></b> %</td>
                  </tr>
                </tbody>
              </table>
            </div>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="panel panel-default">
            <div class="panel-heading">
              <i class="fa fa-bar-chart-o fa-fw"></i><h4>수리업체 - 제조사 클릭 비중</h4>
            </div>
            <div class="panel-body">
              <!-- <div class="btn-group" role="group" aria-label="...">
                <button type="button" class="btn btn-primary" style="background-color:#3F51B5">삼성</button>
                <button type="button" class="btn btn-primary" style="background-color:#757575">애플</button>
                <button type="button" class="btn btn-primary" style="background-color:#B71C1C">엘지</button>
                <button type="button" class="btn btn-primary" style="background-color:#2196F3">팬텍</button>
                <button type="button" class="btn btn-primary" style="background-color:#212121">기타</button>
              </div> -->
              <div id="donut-example" height="100px"></div>
            </div>
        </div>
      </div>
    </div>
  </div>

</body>


  <script src="./script/jquery-2.1.4.min.js" ></script>
  <script src="./script/custom/common.js"></script>
  <script src="./script/custom/moment.js"></script>
  <script src="./script/custom/moment-locale-kr.js"></script>
  <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
  <script src="./script/bootstrap/bootstrap.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script> <!-- morris -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script> <!-- morris -->
  <script type="text/javascript" src="http://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>

  <script>
    moment.locale('ko');
    // alert( moment.duration(123, "minutes").humanize() )


    $(document).ready(function(){
      loginCheck().done(function(data){
        if(!data.is_login){
          alert("로그인이 필요합니다.")
          location.href = "./login.html"
        }
        getData(moment().subtract(1, 'days').format('YYYY-MM-DD'), moment().subtract(1, 'days').format('YYYY-MM-DD'))
        // getData(moment().format('YYYY-MM-DD'), moment().format('YYYY-MM-DD'))
      });
    });



    var yesterday = moment().subtract(1, 'days')

    $("#daterange").daterangepicker({
        opens : "center",
        startDate : yesterday,
        endDate : yesterday,
        maxDate : yesterday,
        locale : {
          applyLabel: '적용',
          cancelLabel: '취소',
          format: 'YYYY/MM/DD',
          firstDay: 1
        }
    });

    $('#daterange').on('apply.daterangepicker', function(e, picker) {
      // console.log("startDate", picker.startDate.format('YYYY-MM-DD'));
      // console.log("endDate", picker.endDate.format('YYYY-MM-DD'));
      getData(picker.startDate.format('YYYY-MM-DD'), picker.endDate.format('YYYY-MM-DD'))
    });

    var morris = Morris.Donut({
      element: 'donut-example',
      data : [],
      data: [
        {label: "삼성", value: 20},
        {label: "애플", value: 20},
        {label: "엘지", value: 20},
        {label: "팬텍", value: 20},
        {label: "기타", value: 20}
      ],
      colors:['#3F51B5',"#757575","#B71C1C","#2196F3","#212121"]
    });


    var bar_down = Morris.Line({
      element: 'line-example',
      data: [
      ],
      xkey: 'date',
      ykeys: ['users', 'new_users'],
      labels: ['일일사용자', '새 사용자(다운로드)']
    });

    var getData = function(start_date, end_date){
      var qs = "start_date="+start_date+"&end_date="+end_date;
      ajax('GET', '/employees/analytics?'+qs, null, {})
      .done(function(result){
        makeGAFormData(result.result);
      })
      .fail(function(err){
        alert(err)
      })
    }

    var makeGAFormData = function(data){
      // console.log(data);
      $("#download_count").text(data.download_count)
      $("#user_count").text(data.user_count)
      $("#duration_time").text(secondToMinute(data.duration_time))
      $("#sell_store_click_rate1").text(data.sell_store_click_rate1)
      $("#sell_store_click_rate2").text(data.sell_store_click_rate2)
      $("#sell_store_contact_rate").text(data.sell_store_contact_rate)
      $("#market_post_rate1").text(data.market_post_rate1)
      $("#market_post_rate2").text(data.market_post_rate2)
      $("#market_sell_rate").text(data.market_sell_rate)
      $("#repair_store_click_rate1").text(data.repair_store_click_rate1)
      $("#repair_store_click_rate2").text(data.repair_store_click_rate2)
      makeRepairDonutdata(data.repair_store_brand_spread);
      makeDownloadLineData(data.results);
    }

    var makeDownloadLineData = function(arr){
      for(i in arr){
        arr[i].date = moment(arr[i].date).format('YYYY-MM-DD');
        delete arr[i].repairstore_select
        delete arr[i].sesssion_duration
        delete arr[i].market_sell_rate
      }
      bar_down.setData(arr)
    }

    var makeRepairDonutdata = function(obj){
      var data = []
      var row = {}
      for(key in obj){
        row ={}
        // console.log("key", key);
        // console.log("key[obj]", obj[key] );
        if(key == "samsung"){
          row.label = "삼성"
          row.value = obj[key]
        }else if(key == "apple"){
          row.label = "애플"
          row.value = obj[key]
        }else if(key == "lg"){
          row.label = "엘지"
          row.value = obj[key]
        }else if(key == "pantech"){
          row.label = "팬텍"
          row.value = obj[key]
        }else if(key == "etc"){
          row.label = "기타"
          row.value = obj[key]
        }
        data.push(row)
      }
      morris.setData(data)
    }

    function secondToMinute(seconds) {
      var pad = function(x) { return (x < 10) ? "0"+x : x; }
      return pad(parseInt(seconds / 60 % 60)) + "분 " +
             pad(seconds % 60)+"초"
    }


  </script>

</html>